{% extends "base.html" %}

{% block style %}
  <style>
      .user-list {
          height: 105px;
      }
      .user-data {
          margin-top: 21px;
          margin-left: 90px;
      }

      .twitter-timeline {
          width: 100%;
      }
  </style>
{% endblock %}

{% block script %}
  <script type="text/javascript" src="http://comiknowledge.tumblr.com/api/read/json"></script>

  <script>
  $(function() {
      for (i=0; i<5; i++) {
          if (i >= tumblr_api_read["posts-total"]) break;
          var $tumblr = $('<a class="list-group-item"></a>');
          $tumblr.addClass("list-group-item");
          $tumblr.attr("href", tumblr_api_read["posts"][i]["url-with-slug"]);
          var $tumblrHeading = $('<h5 class="list-group-item-heading"></h5>');
          $tumblrHeading.text(tumblr_api_read["posts"][i]["regular-title"]);
          $tumblr.append($tumblrHeading);
          var $tumblrText = $('<small class="list-group-item-text"></small>');
          $tumblrText.text(function() {
              if ($(tumblr_api_read["posts"][i]["regular-body"]).text().length > 80)
                  return $(tumblr_api_read["posts"][i]["regular-body"]).text().substr(0, 80) + "…";
              else
                  return $(tumblr_api_read["posts"][i]["regular-body"]).text();
          });
          $tumblr.append($tumblrText);
          $("#list-tumblr").append($tumblr);
      }
  });
  </script>
{% endblock %}

{% block content %}

  <div class="row">
    <div class="col-sm-4">
      <ul class="list-group">
        <li class="list-group-item user-list">
          {% if user.thumbnail %}<img src="{{ user.thumbnail.url }}" class="img-thumbnail img-responsive" align="left">{% endif %}
          <div class="user-data">
            <strong>{{ user.first_name }}</strong><br>
            {{ user.username }}
          </div>
        </li>
      </ul>

      <ul class="list-group visible-lg visible-md visible-sm" id="list-tumblr">
        <a class="list-group-item" href="http://comiknowledge.tumblr.com"><h4>ComiKnowledge 更新情報</h4></a>
      </ul>
    </div>

    <div class="col-sm-8">
      {% if invited_groups %}
        <div class="alert alert-info">
          <a href="{% url "ck.views.group" %}">
            グループ
            {% for group in invited_groups %}「{{ group.name }}」{% endfor %}
            に招待されています！
          </a>
        </div>
      {% endif %}

      <ul class="list-group">
        <li class="list-group-item">
          <h4>サークル名・ペンネームで検索</h4>
          <form class="form-inline" action="{% url "ck.views.search" %}" role="search" method="post">{% csrf_token %}
            <div class="form-group" style="width: 89%; display: inline-block;">
              <label class="sr-only" for="form-home-search">検索</label>
              <input type="text" class="form-control" id="form-home-search" name="keyword" placeholder="検索">
            </div>
            <div class="form-group" style="width: 10%; display: inline-block;">
              <button type="submit" class="btn btn-primary"><span class="glyphicon glyphicon-search"></span></button>
            </div>
          </form>
        </li>
      </ul>

      <ul class="list-group">
        <li class="list-group-item"><h4>最新のコメント</h4></li>
        {% for comment, data in recent_comments.items %}
          <a class="list-group-item" href={% url "ck.views.circle" comment.parent_circle_knowledge.circle_knowledge_id %}>
            {% if comment.onymous %}
              {% if comment.parent_user.thumbnail %}
                <img src="{{ comment.parent_user.thumbnail.url }}" align="left" style="height: 40px; margin-top: -10px; margin-left: -15px; margin-right: 15px; {% if forloop.last %}border-bottom-left-radius: 4px;{% endif %}">
              {% endif %}
            {% else %}
              <img src="{{ STATIC_URL }}png/thumbnail_73.png" align="left" style="height: 40px; margin-top: -10px; margin-left: -15px; margin-right: 15px;">
            {% endif %}
            <strong>{{ data.circle_name }}</strong>
            {% ifequal comment.event_code 0 %}
              {{ comment.event_time_hour|stringformat:"02d" }}:{{ comment.event_time_min|stringformat:"02d" }}
              {% if comment.comment %}{{ comment.comment }}{% endif %}
            {% endifequal %}
            {% ifequal comment.event_code 1 %}
              {{ comment.start_time_hour|stringformat:"02d" }}:{{ comment.start_time_min|stringformat:"02d" }} 〜 {{ comment.finish_time_hour|stringformat:"02d" }}:{{ comment.finish_time_min|stringformat:"02d" }}
              並びました {% if comment.comment %}({{ comment.comment }}){% endif %}
            {% endifequal %}
            {% ifequal comment.event_code 2 %}
              {{ comment.event_time_hour|stringformat:"02d" }}:{{ comment.event_time_min|stringformat:"02d" }}
              頒布物が売り切れました {% if comment.comment %}({{ comment.comment }}){% endif %}
            {% endifequal %}
            {% ifequal comment.event_code 3 %}
              {{ comment.event_time_hour|stringformat:"02d" }}:{{ comment.event_time_min|stringformat:"02d" }}
              現数が変わりました {% if comment.comment %}({{ comment.comment }}){% endif %}
            {% endifequal %}
          </a>
        {% endfor %}
      </ul>

      <ul class="list-group">
        <a class="list-group-item" href="https://twitter.com/comiketofficial"><h4>@comiketofficial</h4></a>
        <li class="list-group-item">
          <a class="twitter-timeline" href="https://twitter.com/comiketofficial" data-widget-id="402990761966182400" data-chrome="noheader transparent" lang="ja">@comiketofficial からのツイート</a>
          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        </li>
      </ul>
    </div>
  </div>
{% endblock %}